name: Deploy to GitHub Pages with SendGrid

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      
      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '16'
          
      - name: Install SendGrid Dependencies
        run: |
          cd api
          npm install
          
      - name: Install Webpack for bundling
        run: npm install -g webpack webpack-cli
          
      - name: Set up API Function
        env:
          SENDGRID_API_KEY: ${{ secrets.SENDGRID_API_KEY }}
        run: |
          # Ensure directories exist
          mkdir -p dist/api
          mkdir -p dist/js
          
          # Copy API files
          cp -r api/* dist/api/
          
          # Create a config file with the key
          echo "// This file is auto-generated by GitHub Actions
          exports.SENDGRID_API_KEY = '${{ secrets.SENDGRID_API_KEY }}';
          " > dist/api/config.js
          
          # Create a webpack config for bundling the SendGrid API
          echo "
          const path = require('path');
          
          module.exports = {
            mode: 'production',
            entry: './dist/api/github-pages-handler.js',
            output: {
              filename: 'github-pages-bundle.js',
              path: path.resolve(__dirname, 'dist/api'),
            },
          };
          " > webpack.config.js
          
          # Bundle the SendGrid API for GitHub Pages
          webpack --config webpack.config.js
          
      - name: Copy website files
        run: |
          # Copy main website files
          cp -r src/* dist/
          cp sendgrid-debug.html dist/
          
          # Add the SendGrid GitHub Pages script to the index.html
          sed -i '/<\/head>/i <script src="js/sendgrid-github.js"></script>' dist/index.html
          
      - name: Create .nojekyll file
        run: touch dist/.nojekyll
        
      - name: Deploy to GitHub Pages
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          folder: dist
          branch: gh-pages 